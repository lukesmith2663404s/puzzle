<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Puzzle</title>
<style>
  body {
    background: #000;
    color: #fff;
    margin: 0;
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  section { display: none; }
  section.active { display: flex; flex-direction: column; align-items: center; gap: 20px; }
  #code input {
    width: 50px; height: 60px;
    font-size: 2em; text-align: center;
    background: #111; border: none; color: #fff;
    text-transform: uppercase;
  }

  .board {
    display: grid;
    grid-template-columns: repeat(5, 80px);
    grid-template-rows: repeat(5, 80px);
    gap: 2px;
  }
  .cell {
    display: flex; align-items: center; justify-content: center;
    font-size: 2em; font-weight: bold;
    background: transparent; color: #fff;
    border: none; cursor: pointer;
    user-select: none;
  }
  .visible {
    background: #111;
    outline: 1px solid #222;
  }
  .filled { cursor: default; }
  .outer {
    background: #000;
    pointer-events: none;
  }
  .outerEnabled .outer { pointer-events: auto; }
  button {
    padding: 10px 20px; background: #222; border: none; color: #fff;
    cursor: pointer; font-size: 1em;
  }
  #result {
    font-size: 1.2em;
    min-height: 1.2em;
  }
</style>
</head>
<body>

<section id="code" class="active">
  <div>
    <input maxlength="1"><input maxlength="1"><input maxlength="1"><input maxlength="1"><input maxlength="1">
  </div>
</section>

<section id="puzzle1">
  <div id="result"></div>
  <div class="board" id="board"></div>
  <button id="reset">Reset</button>
</section>

<section id="puzzle2">
  <div style="width:200px;height:200px;background:#111;"></div>
</section>

<script>
/* --- Code gate --- */
const CODE = "JONES";
const codeInputs = document.querySelectorAll('#code input');
codeInputs.forEach((input, idx) => {
  input.addEventListener('input', () => {
    input.value = input.value.toUpperCase().slice(0,1);
    if (idx < codeInputs.length-1 && input.value) codeInputs[idx+1].focus();
    checkCode();
  });
});
function checkCode() {
  const val = Array.from(codeInputs).map(i=>i.value).join('');
  if (val === CODE) showSection('puzzle1');
}
function showSection(id) {
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'puzzle1') ensurePuzzle1Init();
}

/* --- Puzzle 1: Noughts & Crosses --- */
const boardEl = document.getElementById('board');
let built = false;

let inner = Array(9).fill('');
let gameOver = false;
let outerEnabled = false;
let outerO = new Set();
let cpuFirstMove = true;
const X = 'X', O = 'O';
const resultEl = document.getElementById('result');

function ensurePuzzle1Init() {
  if (!built) {
    buildBoard();
    built = true;
  }
  resetGame();
}

function buildBoard() {
  boardEl.innerHTML = '';
  for (let r = 0; r < 5; r++) {
    for (let c = 0; c < 5; c++) {
      const isInner = r>=1 && r<=3 && c>=1 && c<=3;
      const idx3 = (r-1)*3 + (c-1);
      const btn = document.createElement('button');
      btn.className = 'cell ' + (isInner ? 'visible' : 'outer');
      btn.addEventListener('click', () => handleClick(r, c, isInner, idx3));
      boardEl.appendChild(btn);
    }
  }
  render();
}

function render() {
  const cells = boardEl.children;
  for (let r = 0; r < 5; r++) {
    for (let c = 0; c < 5; c++) {
      const idx = r*5 + c;
      const cell = cells[idx];
      const isInner = r>=1 && r<=3 && c>=1 && c<=3;
      cell.textContent = '';
      if (isInner) {
        const idx3 = (r-1)*3 + (c-1);
        const v = inner[idx3];
        if (v) {
          cell.textContent = v;
          cell.classList.add('filled');
        } else {
          cell.classList.remove('filled');
        }
        cell.disabled = gameOver || !!v;
      }
    }
  }
  boardEl.classList.toggle('outerEnabled', outerEnabled);
}

function handleClick(r,c,isInner,idx3) {
  if (isInner && !gameOver) {
    if (inner[idx3]) return;
    inner[idx3] = O;
    render();

    const res1 = checkWinner3(inner);
    if (res1) return finish3(res1);

    cpuMove();
    render();

    const res2 = checkWinner3(inner);
    if (res2) return finish3(res2);

  } else if (!isInner && outerEnabled) {
    const key = `${r},${c}`;
    if (outerO.has(key)) return;
    outerO.add(key);
    if (checkOThreeInRow5()) {
      finish3(O);
      showSection('puzzle2');
    }
  }
}

function finish3(res) {
  gameOver = true;
  outerEnabled = (res === X || res === 'tie' || res === O);
  resultEl.textContent = res === 'tie' ? 'Tie' : (res === X ? 'Lose' : 'Win');
  render();
}

function resetGame() {
  inner = Array(9).fill('');
  gameOver = false;
  outerEnabled = false;
  outerO.clear();
  cpuFirstMove = true;
  resultEl.textContent = '';
  cpuMove(); // CPU goes first at start
  render();
}

document.getElementById('reset').onclick = resetGame;

/* Minimax */
const LINES_3 = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];
function checkWinner3(b) {
  for (const [a,b1,c] of LINES_3) if (b[a] && b[a]===b[b1] && b[a]===b[c]) return b[a];
  if (b.every(v=>v)) return 'tie';
  return null;
}
function cpuMove() {
  if (cpuFirstMove) {
    cpuFirstMove = false;
    inner[4] = X; // centre
    return;
  }
  const best = bestMove(inner, X);
  if (best.index !== -1) inner[best.index] = X;
}
function bestMove(board, player) {
  const winner = checkWinner3(board);
  if (winner === X) return { score: 10, index: -1 };
  if (winner === O) return { score: -10, index: -1 };
  if (winner === 'tie') return { score: 0, index: -1 };

  const avail = board.map((v,i)=>v?null:i).filter(i=>i!==null);
  let best = { index: -1, score: player===X ? -Infinity : Infinity };

  for (const i of avail) {
    board[i] = player;
    const result = bestMove(board, player===X?O:X);
    board[i] = '';
    const score = result.score + (player===X ? -1 : 1);
    if (player===X) {
      if (score > best.score) best = { index: i, score };
    } else {
      if (score < best.score) best = { index: i, score };
    }
  }
  return best;
}

/* Outer ring 3-in-a-row detection */
function buildOGrid5() {
  const g = Array.from({length:5},()=>Array(5).fill(false));
  for (let r=1; r<=3; r++) for (let c=1; c<=3; c++) {
    const idx3 = (r-1)*3+(c-1);
    if (inner[idx3]===O) g[r][c]=true;
  }
  outerO.forEach(k => {
    const [r,c] = k.split(',').map(Number);
    g[r][c]=true;
  });
  return g;
}
function checkOThreeInRow5() {
  const g = buildOGrid5();
  const dirs = [[0,1],[1,0],[1,1],[1,-1]];
  for (let r=0;r<5;r++) for (let c=0;c<5;c++) if (g[r][c]) {
    for (const [dr,dc] of dirs) {
      const r2=r+dr,c2=c+dc,r3=r+2*dr,c3=c+2*dc;
      if (g[r2]?.[c2] && g[r3]?.[c3]) return true;
    }
  }
  return false;
}
</script>

</body>
</html>
