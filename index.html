<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Puzzle Challenge</title>
<style>
  /* Base */
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    background-color: #121212;
    color: #ffffff;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
  }

  /* Sections */
  .puzzle-section { display: none; margin-top: 20px; }
  #code-entry { display: block; }

  /* Code entry */
  .code-input {
    width: 40px; height: 40px;
    text-align: center;
    font-size: 24px;
    margin: 5px;
    background: #1e1e1e !important;
    color: #fff !important;
    border: 1px solid #333 !important;
    outline: none;
    text-transform: uppercase;
  }

  /* Puzzle 1 (Tic-tac-toe with secret ring) */
  .outer-ring {
    display: grid;
    grid-template-columns: repeat(5, 60px);
    grid-gap: 2px;
    margin: 0 auto;
    justify-content: center;
    justify-items: center;
  }
  .outer-cell {
    width: 60px; height: 60px;
    background-color: transparent;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px;
    cursor: pointer; user-select: none;
    border: none;
  }
  .cell {
    width: 60px; height: 60px; /* inner 3x3 visible cells */
    background-color: #1e1e1e;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px; user-select: none;
  }
  .outer-cell.visibleO { background-color: #1e1e1e; color: #fff; }
  #result { font-size: 24px; margin-top: 12px; min-height: 28px; }
  button { margin-top: 12px; padding: 10px 20px; font-size: 16px; }

  /* Puzzle 2 (Crossword) */
  #puzzle2 .crossword {
    border-collapse: collapse;
    table-layout: fixed;
    margin: 60px auto 12px auto; /* space above for readability */
  }
  #puzzle2 .crossword td {
    position: relative;
    width: 40px; height: 40px;
    border: 1px solid #444 !important; /* force vertical lines too */
    padding: 0;
    background: #111;
  }
  #puzzle2 .crossword td.black { background: #000 !important; }
  #puzzle2 .cw-cell {
    width: 100%; height: 100%;
    border: none; outline: none;
    text-align: center;
    font-size: 20px;
    color: #000 !important;
    background: #fff !important;
    text-transform: uppercase;
    display: block;
  }
  #puzzle2 .cw-num {
    position: absolute;
    top: 2px; left: 2px;
    font-size: 10px; color: #000;
    z-index: 2; pointer-events: none;
  }
  #crossword-wrapper {
    display: flex; flex-direction: column; align-items: center;
    width: 100%;
  }
  #crossword-clues {
    text-align: left;
    max-width: 600px;
    margin: 8px auto 24px auto;
    color: white;
  }

  /* Puzzle 3 (Clock) - keep scoped to puzzle3 so other styling unaffected */
  #puzzle3 .clock-wrapper {
    margin-top: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  #puzzle3 .clock {
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: inherit;
    color: white;
    font-size: 48px;
    letter-spacing: 2px;
  }
  #puzzle3 .half {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 90px;
  }
  #puzzle3 .half .value {
    background: #1e1e1e;
    padding: 8px 16px;
    border-radius: 6px;
    min-width: 60px;
    text-align: center;
    font-size: 40px;
    color: white;
    box-shadow: none;
  }
  #puzzle3 .prime-btn {
    margin-top: 8px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
  }
  #puzzle3 #next3 {
    display: none;
    margin-top: 8px;
  }
</style>
</head>
<body>

<!-- Code entry -->
<div id="code-entry" class="puzzle-section" style="display:block;">
  <h1>Enter Code</h1>
  <div>
    <input type="text" maxlength="1" class="code-input" id="code1">
    <input type="text" maxlength="1" class="code-input" id="code2">
    <input type="text" maxlength="1" class="code-input" id="code3">
    <input type="text" maxlength="1" class="code-input" id="code4">
    <input type="text" maxlength="1" class="code-input" id="code5">
  </div>
</div>

<!-- Puzzle 1 -->
<div id="puzzle1" class="puzzle-section">
  <h1>Puzzle 1</h1>
  <div id="outer-ring" class="outer-ring"></div>
  <div id="result"></div>
  <button id="reset-btn">Reset</button>
  <button id="next1" style="display:none;" onclick="showSection('puzzle2')">Next</button>
</div>

<!-- Puzzle 2 -->
<div id="puzzle2" class="puzzle-section">
  <div id="crossword-wrapper">
    <div id="crossword-container"></div>
    <button id="next2" style="display:none;" onclick="showSection('puzzle3')">Next</button>
  </div>

  <div id="crossword-clues">
    <h3>ACROSS</h3>
    <p>1A. 2F Lecturers</p>
    <p>5A. With 8A, despite the fact you doubted me on this at first 4 years ago, the chance of choosing the door with the car behind it, if you choose to switch doors from your initial choice, where Monty doesn't know where the car is and resets the game if he reveals the car.</p>
    <p>6A. What e = 2?</p>
    <p>8A. See 5A</p>
    <p>10A. Donned on body parts the same length as your forearm. Can be checked during maths lectures, apparently.</p>
    <h3>DOWN</h3>
    <p>1D. Fastened bands, strips of land, technique of loud vocalist.</p>
    <p>2D. George and Ruthie's specialty</p>
    <p>3D. The beginning of knowledge...</p>
    <p>4D. What does a sender do?</p>
    <p>7D. You might well say this in satisfaction when solving this crossword</p>
    <p>9D. So you want to know 9D? Well I've heard ( ln(S^2+2)^2 + ln(T^2+e)^2 + exp(U^2) + arctan(V)^2 + (abs(W)+1)^3 + sin(X)^2 + (R^2+K^2+D^2+1)^5 + 1 ) * (-1 - ((RK/D)^(1/2) - 4)) = 0. And writing the parameters in the solutions to these things alphabetically is so last year.</p>
  </div>
</div>

<!-- Puzzle 3 -->
<div id="puzzle3" class="puzzle-section">
  <h1>Puzzle 3</h1>

  <div class="clock-wrapper" aria-live="polite">
    <div class="clock" id="clock">
      <div class="half" id="hour-half">
        <div class="value" id="hour-value">00</div>
        <button class="prime-btn" id="primeHourBtn">Prime Time?</button>
      </div>

      <div style="font-size:40px;color:white;opacity:0.9;">:</div>

      <div class="half" id="minute-half">
        <div class="value" id="minute-value">00</div>
        <button class="prime-btn" id="primeMinuteBtn">Prime Time?</button>
      </div>
    </div>

    <button id="next3" onclick="showSection('puzzle4')">Next</button>
  </div>
</div>

<!-- Puzzle 4 placeholder -->
<div id="puzzle4" class="puzzle-section">
  <h1>Puzzle 4 (placeholder)</h1>
  <p>This is a placeholder for Puzzle 4.</p>
</div>

<script>
/* Section switching */
function showSection(id) {
  document.querySelectorAll('.puzzle-section').forEach(sec => sec.style.display = 'none');
  const el = document.getElementById(id);
  el.style.display = 'block';
  // start/init hooks
  if (id === 'puzzle1') startPuzzle1();
  if (id === 'puzzle2') buildCrossword();
  if (id === 'puzzle3') initPuzzle3();
}

/* Code entry */
const codeInputs = document.querySelectorAll('.code-input');
codeInputs.forEach((input, index) => {
  input.addEventListener('input', () => {
    input.value = input.value.toUpperCase();
    if (input.value.length === 1 && index < codeInputs.length - 1) {
      codeInputs[index + 1].focus();
    }
    checkCode();
  });
});
function checkCode() {
  const code = Array.from(codeInputs).map(inp => inp.value.toUpperCase()).join('');
  if (code === 'JONES') {
    showSection('puzzle1');
  }
}

/* --- Puzzle 1 logic (unchanged) --- */
let outerRing = [];
let gameActive = true;

// Inner 3x3 mapping within the 5x5 board (row-major indices 0..24)
const innerToOuter = [6,7,8,11,12,13,16,17,18];
const winsOuter = [
  [6,7,8],[11,12,13],[16,17,18],
  [6,11,16],[7,12,17],[8,13,18],
  [6,12,18],[8,12,16]
];
// extendedTriplets copied from previous working config
const extendedTriplets = [
  [5,6,7], [7,8,9],
  [10,11,12], [12,13,14],
  [15,16,17], [17,18,19],
  [1,6,11], [11,16,21],
  [2,7,12], [12,17,22],
  [3,8,13], [13,18,23],
  [0,6,12], [12,18,24],
  [4,8,12], [12,16,20]
];

function startPuzzle1() {
  const outerRingContainer = document.getElementById('outer-ring');
  outerRingContainer.innerHTML = '';
  gameActive = true;
  outerRing = Array(25).fill(null);
  document.getElementById('result').textContent = '';
  document.getElementById('next1').style.display = 'none';

  // Build 5x5, attach handlers to cells
  for (let i = 0; i < 25; i++) {
    const cell = document.createElement('div');
    cell.classList.add('outer-cell');
    if (innerToOuter.includes(i)) {
      cell.classList.add('cell'); // inner 3x3 visible squares
      cell.addEventListener('click', () => handlePlayerMove(i));
    } else {
      // Outer ring: only works AFTER the game ends (lose or tie)
      cell.addEventListener('click', () => handleOuterClick(i));
    }
    outerRingContainer.appendChild(cell);
  }

  cpuMove(); // CPU opens in the center
}

function getInnerBoard() {
  return innerToOuter.map(i => outerRing[i]);
}
function innerEmpty(b) {
  return b.every(v => v === null);
}
function winner3(b) {
  const lines = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  for (const [a,b2,c] of lines) {
    if (b[a] && b[a] === b[b2] && b[a] === b[c]) return b[a];
  }
  if (b.every(x => x !== null)) return 'tie';
  return null;
}
function minimax(b, isMax, depth=0) {
  const w = winner3(b);
  if (w === 'X') return 10 - depth;
  if (w === 'O') return depth - 10;
  if (w === 'tie') return 0;
  if (isMax) {
    let best = -Infinity;
    for (let i=0;i<9;i++) {
      if (b[i] === null) {
        b[i] = 'X';
        best = Math.max(best, minimax(b, false, depth+1));
        b[i] = null;
      }
    }
    return best;
  } else {
    let best = Infinity;
    for (let i=0;i<9;i++) {
      if (b[i] === null) {
        b[i] = 'O';
        best = Math.min(best, minimax(b, true, depth+1));
        b[i] = null;
      }
    }
    return best;
  }
}
function cpuMove() {
  if (!gameActive) return;
  const b = getInnerBoard();
  // First move center
  if (innerEmpty(b) && outerRing[12] === null) {
    makeMove(12, 'X');
    return;
  }
  // Minimax follow-ups
  let best = -Infinity;
  let bestInner = null;
  for (let i=0;i<9;i++) {
    if (b[i] === null) {
      b[i] = 'X';
      const score = minimax(b, false, 0);
      b[i] = null;
      if (score > best) {
        best = score;
        bestInner = i;
      }
    }
  }
  if (bestInner !== null) {
    const outerIdx = innerToOuter[bestInner];
    makeMove(outerIdx, 'X');
  }
}
function makeMove(index, player) {
  const cell = document.getElementById('outer-ring').children[index];
  if (!cell || outerRing[index] !== null) return;
  cell.textContent = player;
  if (player === 'O') cell.classList.add('visibleO');
  outerRing[index] = player;
  if (innerToOuter.includes(index)) {
    if (isWinInner(player)) {
      document.getElementById('result').textContent = (player === 'O') ? 'You Win!' : 'You Lose!';
      gameActive = false;
      if (player === 'O') document.getElementById('next1').style.display = 'block';
      return;
    }
    if (isTieInner()) {
      document.getElementById('result').textContent = 'Tie!';
      gameActive = false;
      return;
    }
  }
}
function handlePlayerMove(index) {
  if (!gameActive) return;
  if (outerRing[index] !== null) return;
  makeMove(index, 'O');
  if (gameActive) cpuMove();
}
function handleOuterClick(index) {
  if (gameActive) return;                 // Not allowed until the game ends
  if (innerToOuter.includes(index)) return;
  if (outerRing[index] !== null) return;
  makeMove(index, 'O'); // visible O placed on the outer ring
  if (isExtendedWinO()) {
    document.getElementById('result').textContent = 'You Win!';
    document.getElementById('next1').style.display = 'block';
  }
}
function isWinInner(player) {
  return winsOuter.some(line => line.every(i => outerRing[i] === player));
}
function isTieInner() {
  return innerToOuter.every(i => outerRing[i] !== null);
}
function isExtendedWinO() {
  return extendedTriplets.some(tri => tri.every(i => outerRing[i] === 'O'));
}
document.getElementById('reset-btn').addEventListener('click', startPuzzle1);

/* --- Puzzle 2 (Crossword) --- */
function buildCrossword() {
  const container = document.getElementById('crossword-container');
  container.innerHTML = '';
  const grid = [
    ['B','E','L','K','S'],
    ['E','*','O','N','E'],
    ['L','O','G','*','N'],
    ['T','H','I','R','D'],
    ['S','O','C','K','S']
  ];
  const numbers = {
    '0,0':1,'0,2':2,'0,3':3,'0,4':4,
    '1,2':5,'2,0':6,'2,1':7,'3,0':8,
    '3,3':9,'4,0':10
  };
  const table = document.createElement('table');
  table.className = 'crossword';
  for (let r=0;r<5;r++) {
    const tr = document.createElement('tr');
    for (let c=0;c<5;c++) {
      const td = document.createElement('td');
      if (grid[r][c] === '*') {
        td.classList.add('black');
      } else {
        const input = document.createElement('input');
        input.maxLength = 1;
        input.className = 'cw-cell';
        input.dataset.row = r;
        input.dataset.col = c;
        td.appendChild(input);
      }
      if (numbers[`${r},${c}`]) {
        const num = document.createElement('span');
        num.className = 'cw-num';
        num.textContent = numbers[`${r},${c}`];
        td.appendChild(num);
      }
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  container.appendChild(table);
  container.addEventListener('input', checkCrossword);
}
function checkCrossword() {
  const target = [
    ['B','E','L','K','S'],
    ['E','','O','N','E'],
    ['L','O','G','','N'],
    ['T','H','I','R','D'],
    ['S','O','C','K','S']
  ];
  let correct = true;
  document.querySelectorAll('#crossword-container .cw-cell').forEach(cell => {
    const r = parseInt(cell.dataset.row, 10);
    const c = parseInt(cell.dataset.col, 10);
    const expected = target[r][c];
    const val = (cell.value || '').toUpperCase();
    if (val !== expected) correct = false;
  });
  if (correct) {
    document.getElementById('next2').style.display = 'inline-block';
  }
}

/* --- Puzzle 3 (Clock + Prime check) --- */
let puzzle3Interval = null;
const primesUnder60 = new Set([2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59]);

function initPuzzle3() {
  // clear any previous interval (if returning)
  if (puzzle3Interval) clearInterval(puzzle3Interval);
  updateClock(); // initial
  puzzle3Interval = setInterval(updateClock, 1000);

  // ensure next button hidden on entry
  document.getElementById('next3').style.display = 'none';

  // attach handlers (idempotent)
  document.getElementById('primeHourBtn').onclick = checkPrimeTime;
  document.getElementById('primeMinuteBtn').onclick = checkPrimeTime;
}

function updateClock() {
  const now = new Date();
  const hh = now.getHours();
  const mm = now.getMinutes();
  const hhStr = String(hh).padStart(2,'0');
  const mmStr = String(mm).padStart(2,'0');
  document.getElementById('hour-value').textContent = hhStr;
  document.getElementById('minute-value').textContent = mmStr;
}

function checkPrimeTime() {
  const hourText = document.getElementById('hour-value').textContent;
  const minuteText = document.getElementById('minute-value').textContent;
  const hh = parseInt(hourText, 10);
  const mm = parseInt(minuteText, 10);

  const messages = [];
  if (!primesUnder60.has(hh)) messages.push(`${hourText} isn't prime`);
  if (!primesUnder60.has(mm)) messages.push(`${minuteText} isn't prime`);

  if (messages.length > 0) {
    alert(messages.join('\n'));
  } else {
    // both prime -> reveal Next button
    document.getElementById('next3').style.display = 'inline-block';
  }
}
</script>

</body>
</html>
